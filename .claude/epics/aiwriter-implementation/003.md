---
name: "003-后端服务架构设置"
description: "搭建后端服务架构，配置Express服务器、数据库连接和API接口结构"
status: "pending"
priority: "high"
assigned_to: ""
labels: ["backend", "architecture", "setup"]
type: "task"
epic: "aiwriter-implementation"
story_points: 13
created: "2025-09-04T01:26:29Z"
updated: "2025-09-04T01:26:29Z"
due_date: ""
blocked_by: ["001-项目初始化和环境搭建"]
blocking: []
---

# 任务：后端服务架构设置

## 任务描述

搭建完整的后端服务架构，包括Express服务器配置、数据库连接、API接口设计和中间件配置，为前端提供稳定的数据服务。

## 任务目标

- [ ] 配置Express服务器和中间件
- [ ] 设置SQLite数据库连接和模型
- [ ] 设计RESTful API接口结构
- [ ] 实现错误处理和日志系统
- [ ] 配置安全中间件和CORS
- [ ] 集成Google Gemini API服务

## 详细步骤

### 1. Express服务器配置
- [ ] 创建Express应用入口文件：
  - `src/server.ts`
  - `src/app.ts`
- [ ] 配置核心中间件：
  - `body-parser` (JSON和URL编码解析)
  - `cors` (跨域资源共享)
  - `helmet` (安全头部)
  - `morgan` (HTTP请求日志)
- [ ] 配置服务器启动和端口设置
- [ ] 实现健康检查端点

### 2. 数据库配置
- [ ] 配置SQLite数据库连接：
  - `src/database/connection.ts`
  - `src/database/config.ts`
- [ ] 设计数据库模型结构：
  - `src/database/models/`
  - `src/database/models/Account.ts`
  - `src/database/models/Material.ts`
  - `src/database/models/Topic.ts`
  - `src/database/models/Content.ts`
  - `src/database/models/Review.ts`
- [ ] 实现数据库迁移和初始化脚本
- [ ] 创建数据库工具函数：
  - `src/database/utils.ts`
  - `src/database/seeds.ts`

### 3. API接口设计
- [ ] 创建路由基础结构：
  - `src/routes/`
  - `src/routes/index.ts`
  - `src/routes/types.ts`
- [ ] 实现核心API路由：
  - 账号管理路由 (`/api/accounts`)
  - 素材管理路由 (`/api/materials`)
  - 选题管理路由 (`/api/topics`)
  - 内容管理路由 (`/api/content`)
  - 审查管理路由 (`/api/reviews`)
- [ ] 创建控制器层：
  - `src/controllers/`
  - `src/controllers/AccountController.ts`
  - `src/controllers/MaterialController.ts`
  - `src/controllers/TopicController.ts`
  - `src/controllers/ContentController.ts`
  - `src/controllers/ReviewController.ts`

### 4. 中间件和错误处理
- [ ] 实现全局错误处理中间件
- [ ] 创建请求验证中间件
- [ ] 实现认证和授权中间件
- [ ] 配置请求日志中间件
- [ ] 创建响应格式化中间件
- [ ] 实现API限流中间件

### 5. 服务层架构
- [ ] 创建服务层基础结构：
  - `src/services/`
  - `src/services/AccountService.ts`
  - `src/services/MaterialService.ts`
  - `src/services/TopicService.ts`
  - `src/services/ContentService.ts`
  - `src/services/ReviewService.ts`
- [ ] 实现业务逻辑处理
- [ ] 创建数据访问层（DAO）：
  - `src/dao/`
  - `src/dao/BaseDAO.ts`
  - `src/dao/AccountDAO.ts`

### 6. AI服务集成
- [ ] 集成Google Gemini API：
  - `src/services/ai/GeminiService.ts`
  - `src/services/ai/types.ts`
  - `src/services/ai/config.ts`
- [ ] 实现AI内容生成功能
- [ ] 创建AI服务错误处理
- [ ] 配置AI请求限流和重试机制

### 7. 工具函数和配置
- [ ] 创建工具函数库：
  - `src/utils/`
  - `src/utils/logger.ts`
  - `src/utils/validators.ts`
  - `src/utils/formatters.ts`
  - `src/utils/errorHandler.ts`
- [ ] 配置环境变量管理
- [ ] 创建配置文件：
  - `src/config/`
  - `src/config/database.ts`
  - `src/config/app.ts`
  - `src/config/ai.ts`

## 验收标准

### 功能性验收
- [ ] Express服务器可以正常启动
- [ ] 数据库连接正常，可以执行CRUD操作
- [ ] 所有API端点可以正常响应
- [ ] 错误处理机制正常工作
- [ ] AI服务集成成功

### 技术性验收
- [ ] 后端项目可以正常构建和运行
- [ ] 所有中间件配置正确
- [ ] 数据库模型定义完整
- [ ] API接口符合RESTful规范
- [ ] 日志系统正常记录

### 性能验收
- [ ] API响应时间 < 100ms
- [ ] 数据库查询优化
- [ ] 内存使用合理
- [ ] 并发处理能力测试通过

## 技术要求

### 后端技术栈详细配置
- **运行时**: Node.js 18+
- **框架**: Express 4.18+
- **数据库**: SQLite 3+
- **ORM**: 原生SQLite3驱动
- **AI服务**: Google Generative AI SDK
- **日志**: Morgan + Winston
- **验证**: Joi/Express-validator

### 项目结构规范
```
src/
├── server.ts           # 服务器入口
├── app.ts              # Express应用配置
├── routes/             # 路由定义
│   ├── index.ts        # 路由聚合
│   ├── accounts.ts     # 账号路由
│   ├── materials.ts    # 素材路由
│   ├── topics.ts       # 选题路由
│   ├── content.ts      # 内容路由
│   └── reviews.ts      # 审查路由
├── controllers/        # 控制器层
│   ├── AccountController.ts
│   ├── MaterialController.ts
│   ├── TopicController.ts
│   ├── ContentController.ts
│   └── ReviewController.ts
├── services/           # 服务层
│   ├── AccountService.ts
│   ├── MaterialService.ts
│   ├── TopicService.ts
│   ├── ContentService.ts
│   ├── ReviewService.ts
│   └── ai/             # AI服务
│       ├── GeminiService.ts
│       └── config.ts
├── dao/                # 数据访问层
│   ├── BaseDAO.ts
│   ├── AccountDAO.ts
│   ├── MaterialDAO.ts
│   ├── TopicDAO.ts
│   ├── ContentDAO.ts
│   └── ReviewDAO.ts
├── database/           # 数据库配置
│   ├── connection.ts   # 数据库连接
│   ├── config.ts       # 数据库配置
│   ├── models/         # 数据模型
│   │   ├── Account.ts
│   │   ├── Material.ts
│   │   ├── Topic.ts
│   │   ├── Content.ts
│   │   └── Review.ts
│   ├── migrations/     # 数据库迁移
│   └── seeds/          # 种子数据
├── middleware/         # 中间件
│   ├── errorHandler.ts
│   ├── auth.ts
│   ├── validation.ts
│   └── logging.ts
├── utils/              # 工具函数
│   ├── logger.ts
│   ├── validators.ts
│   ├── formatters.ts
│   └── errorHandler.ts
├── config/             # 配置文件
│   ├── database.ts
│   ├── app.ts
│   └── ai.ts
└── types/              # 类型定义
    ├── api.ts
    ├── models.ts
    └── common.ts
```

### API设计规范
- 使用RESTful API设计原则
- 统一的响应格式
- 完整的错误处理
- 请求参数验证
- API版本控制

## 风险评估

### 技术风险
- **数据库连接问题**: 实现连接池和重试机制
- **API性能问题**: 使用缓存和查询优化
- **AI服务稳定性**: 实现降级和重试策略
- **安全性问题**: 配置安全中间件和输入验证

### 缓解措施
- 使用数据库连接池
- 实施API监控和性能优化
- 设计AI服务容错机制
- 进行安全测试和代码审查

## 预估工作量
- **服务器配置**: 3小时
- **数据库设计**: 4小时
- **API接口设计**: 3小时
- **中间件配置**: 2小时
- **服务层实现**: 4小时
- **AI服务集成**: 3小时
- **测试配置**: 2小时
- **总计**: 21小时

## 相关资源
- [Express官方文档](https://expressjs.com/)
- [SQLite官方文档](https://www.sqlite.org/)
- [Google Gemini API文档](https://ai.google.dev/)
- [Node.js最佳实践](https://github.com/goldbergyoni/nodebestpractices)

## 备注
- 确保所有API接口都有完整的错误处理
- 为后续的API文档生成预留接口
- 考虑数据库扩展性和性能优化
- 设计清晰的日志记录和监控机制