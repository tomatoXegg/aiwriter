---
name: "013-选题整合API开发"
description: "开发选题整合的后端API接口，包括AI选题生成、选题管理和Prompt模板系统"
status: "completed"
priority: "high"
assigned_to: ""
labels: ["backend", "api", "topic-generation", "ai-integration"]
type: "task"
epic: "aiwriter-implementation"
story_points: 18
created: "2025-09-04T01:26:29Z"
updated: "2025-09-04T12:00:00Z"
due_date: ""
blocked_by: []
blocking: []
---

# 任务：选题整合API开发

## 任务描述

开发选题整合的后端API接口，集成Google Gemini AI服务实现智能选题生成、选题管理、自定义Prompt模板系统，为内容创作提供高质量的选题建议。

## 任务目标

- [ ] 创建选题管理相关的数据模型
- [ ] 集成Google Gemini AI服务
- [ ] 实现AI选题生成功能
- [ ] 开发选题管理API接口
- [ ] 实现Prompt模板系统
- [ ] 添加选题质量评估和筛选

## 详细步骤

### 1. 数据模型设计
- [ ] 定义Topic数据模型接口
- [ ] 创建数据库表结构（topics表）
- [ ] 设计Prompt模板表结构
- [ ] 创建选题评估表结构

### 2. AI服务集成
- [ ] 集成Google Gemini API客户端
- [ ] 实现AI服务配置和认证
- [ ] 开发AI请求重试和错误处理
- [ ] 实现AI响应解析和处理

### 3. 选题生成功能
- [ ] 实现基于素材的选题生成：POST /api/topics/generate
- [ ] 实现批量选题生成：POST /api/topics/generate/batch
- [ ] 开发自定义Prompt选题生成：POST /api/topics/generate/custom
- [ ] 实现选题质量评分算法

### 4. 选题管理功能
- [ ] 实现选题列表查询：GET /api/topics
- [ ] 实现选题详情查询：GET /api/topics/:id
- [ ] 实现选题状态管理：PUT /api/topics/:id/status
- [ ] 实现选题删除功能：DELETE /api/topics/:id

### 5. Prompt模板系统
- [ ] 实现模板CRUD操作：POST/GET/PUT/DELETE /api/templates
- [ ] 实现模板分类管理：GET /api/templates/categories
- [ ] 实现模板使用统计：GET /api/templates/:id/stats
- [ ] 实现模板推荐功能：GET /api/templates/recommend

### 6. 选题评估和筛选
- [ ] 实现选题质量评估：POST /api/topics/evaluate
- [ ] 实现选题筛选和排序：GET /api/topics/filter
- [ ] 实现选题相似度检测：POST /api/topics/similarity
- [ ] 实现选题历史记录：GET /api/topics/history

## 验收标准

### 功能性验收
- [ ] AI选题生成功能正常工作
- [ ] 选题管理CRUD操作完整
- [ ] Prompt模板系统功能完善
- [ ] 选题评估和筛选准确
- [ ] 与素材系统集成正常

### 技术性验收
- [ ] AI服务调用稳定可靠
- [ ] 选题生成响应时间 < 30秒
- [ ] 数据存储和查询性能良好
- [ ] 错误处理覆盖所有边界情况
- [ ] 代码符合TypeScript类型规范

### 业务验收
- [ ] 选题质量达到可接受水平
- [ ] 支持多种选题生成模式
- [ ] 模板系统灵活易用
- [ ] 评估结果准确合理

## 技术要求

### 后端技术栈
- **框架**: Express 4+
- **语言**: TypeScript 4.8+
- **数据库**: SQLite 3+
- **AI服务**: Google Gemini API
- **缓存**: 内存缓存或Redis

### API设计规范
- **RESTful**: 遵循REST API设计原则
- **异步处理**: 支持长时间运行的AI任务
- **分页**: 支持分页和限制
- **状态管理**: 实现任务状态跟踪
- **缓存**: 实现AI结果缓存

### 数据模型
```typescript
interface Topic {
  id: string;
  title: string;
  description: string;
  materialId: string;
  prompt: string;
  status: 'pending' | 'selected' | 'discarded';
  quality: number;
  category: string;
  tags: string[];
  createdAt: Date;
  updatedAt: Date;
  aiResponse?: string;
  evaluation?: {
    relevance: number;
    creativity: number;
    feasibility: number;
    overall: number;
  };
}

interface PromptTemplate {
  id: string;
  name: string;
  description: string;
  template: string;
  category: string;
  variables: string[];
  usageCount: number;
  isPublic: boolean;
  createdAt: Date;
  updatedAt: Date;
  createdBy: string;
}

interface TopicGeneration {
  id: string;
  materialId: string;
  templateId?: string;
  prompt: string;
  status: 'pending' | 'processing' | 'completed' | 'failed';
  result?: Topic[];
  error?: string;
  createdAt: Date;
  completedAt?: Date;
}
```

## API接口设计

### 生成选题
```typescript
POST /api/topics/generate
Request: {
  materialId: string;
  templateId?: string;
  customPrompt?: string;
  count?: number;
  category?: string;
}
Response: {
  success: boolean;
  data: {
    generationId: string;
    status: 'pending' | 'processing';
    estimatedTime: number;
  };
  message: string;
}
```

### 获取生成结果
```typescript
GET /api/topics/generations/:id
Response: {
  success: boolean;
  data: {
    id: string;
    status: 'pending' | 'processing' | 'completed' | 'failed';
    result?: Topic[];
    error?: string;
    progress: number;
    createdAt: Date;
    completedAt?: Date;
  };
  message: string;
}
```

### 选题列表查询
```typescript
GET /api/topics?page=1&limit=10&status=selected&category=tech&quality=0.8
Response: {
  success: boolean;
  data: {
    topics: Topic[];
    total: number;
    page: number;
    limit: number;
    filters: {
      status?: string;
      category?: string;
      minQuality?: number;
    };
  };
  message: string;
}
```

### 创建Prompt模板
```typescript
POST /api/templates
Request: {
  name: string;
  description: string;
  template: string;
  category: string;
  isPublic?: boolean;
}
Response: {
  success: boolean;
  data: PromptTemplate;
  message: string;
}
```

### 选题质量评估
```typescript
POST /api/topics/evaluate
Request: {
  topicId: string;
  criteria?: {
    relevance?: number;
    creativity?: number;
    feasibility?: number;
  };
}
Response: {
  success: boolean;
  data: {
    topicId: string;
    evaluation: {
      relevance: number;
      creativity: number;
      feasibility: number;
      overall: number;
      feedback: string;
    };
  };
  message: string;
}
```

## 风险评估

### 技术风险
- **AI服务依赖**: Google Gemini API的可用性和限制
- **响应时间**: AI生成可能需要较长时间
- **成本控制**: API调用的成本管理
- **质量控制**: 生成选题的质量和相关性

### 缓解措施
- 实现API调用重试和降级策略
- 使用异步任务队列处理长时间操作
- 实现调用频率限制和配额管理
- 添加人工审核和筛选机制

## 预估工作量
- **需求分析和设计**: 4小时
- **数据模型开发**: 5小时
- **AI服务集成**: 8小时
- **API接口开发**: 12小时
- **测试和调试**: 10小时
- **文档编写**: 4小时
- **总计**: 43小时

## 相关资源
- [Google Gemini API文档](https://ai.google.dev/)
- [Express异步处理](https://expressjs.com/)
- [SQLite全文搜索](https://www.sqlite.org/fts3.html)
- [异步任务队列](https://github.com/OptimalBits/bull)

## 备注
- 考虑添加选题推荐算法
- 实现选题批量操作功能
- 添加选题导出功能
- 考虑支持多种AI服务提供商