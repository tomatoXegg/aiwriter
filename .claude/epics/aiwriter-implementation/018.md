---
name: "018-单元测试和集成测试"
description: "开发全面的单元测试和集成测试套件，确保代码质量和系统稳定性，包括测试框架搭建、测试用例编写和测试覆盖率提升"
status: "pending"
priority: "high"
assigned_to: ""
labels: ["testing", "quality-assurance", "backend", "frontend"]
type: "task"
epic: "aiwriter-implementation"
story_points: 16
created: "2025-09-04T01:26:29Z"
updated: "2025-09-04T01:26:29Z"
due_date: ""
blocked_by: []
blocking: []
---

# 任务：单元测试和集成测试

## 任务描述

开发全面的单元测试和集成测试套件，确保代码质量和系统稳定性，包括测试框架搭建、测试用例编写、测试覆盖率提升和持续集成。

## 任务目标

- [ ] 搭建测试框架和环境
- [ ] 编写后端单元测试
- [ ] 编写前端单元测试
- [ ] 开发集成测试套件
- [ ] 实现测试覆盖率监控
- [ ] 集成到CI/CD流程

## 详细步骤

### 1. 测试框架搭建
- [ ] 选择和配置测试框架（Jest + Testing Library）
- [ ] 设置测试环境和配置
- [ ] 配置测试覆盖率工具
- [ ] 实现测试数据管理
- [ ] 搭建测试报告系统

### 2. 后端单元测试
- [ ] 编写API路由测试
- [ ] 编写服务层测试
- [ ] 编写数据模型测试
- [ ] 编写工具函数测试
- [ ] 编写中间件测试

### 3. 前端单元测试
- [ ] 编写组件测试
- [ ] 编写页面测试
- [ ] 编写状态管理测试
- [ ] 编写Hook测试
- [ ] 编写工具函数测试

### 4. 集成测试
- [ ] 编写API集成测试
- [ ] 编写数据库集成测试
- [ ] 编写AI服务集成测试
- [ ] 编写端到端集成测试
- [ ] 编写工作流集成测试

### 5. 测试覆盖率提升
- [ ] 分析测试覆盖率
- [ ] 补充缺失的测试用例
- [ ] 优化测试代码质量
- [ ] 实现测试数据工厂
- [ ] 建立测试基准

### 6. CI/CD集成
- [ ] 配置持续集成流程
- [ ] 实现自动化测试
- [ ] 配置测试报告生成
- [ ] 实现测试失败通知
- [ ] 建立测试质量门禁

## 验收标准

### 功能性验收
- [ ] 测试框架搭建完成
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试覆盖率 > 70%
- [ ] 测试用例质量良好
- [ ] CI/CD集成成功

### 技术性验收
- [ ] 测试执行速度快
- [ ] 测试稳定性高
- [ ] 测试报告完整
- [ ] 测试数据管理良好
- [ ] 测试工具配置正确

### 业务验收
- [ ] 测试覆盖核心功能
- [ ] 测试发现潜在问题
- [ ] 测试维护成本低
- [ ] 测试文档完整

## 技术要求

### 测试框架
- **单元测试**: Jest 29+
- **前端测试**: React Testing Library
- **后端测试**: Supertest
- **覆盖率**: Istanbul/NYC
- **Mock工具**: Mock Service Worker

### 测试类型
- **单元测试**: 隔离测试各个组件
- **集成测试**: 测试组件间交互
- **端到端测试**: 测试完整业务流程
- **性能测试**: 测试性能指标
- **安全测试**: 测试安全漏洞

### 测试数据模型
```typescript
interface TestConfig {
  framework: {
    unit: 'jest';
    integration: 'jest';
    e2e: 'playwright';
  };
  coverage: {
    threshold: {
      global: number;
      file: number;
      branch: number;
      function: number;
      line: number;
    };
    reporters: ['text', 'lcov', 'html'];
    exclude: ['node_modules', 'dist', 'coverage'];
  };
  environment: {
    test: {
      database: ':memory:';
      apiBaseUrl: 'http://localhost:3000';
      timeout: 30000;
    };
    development: {
      database: './test.db';
      apiBaseUrl: 'http://localhost:3001';
      timeout: 60000;
    };
  };
}

interface TestCase {
  id: string;
  name: string;
  type: 'unit' | 'integration' | 'e2e';
  category: 'component' | 'service' | 'api' | 'database' | 'workflow';
  description: string;
  setup: () => Promise<void>;
  teardown: () => Promise<void>;
  test: () => Promise<void>;
  expected: any;
  timeout?: number;
  tags: string[];
}

interface TestSuite {
  name: string;
  description: string;
  tests: TestCase[];
  setup?: () => Promise<void>;
  teardown?: () => Promise<void>;
  parallel: boolean;
  timeout: number;
}

interface CoverageReport {
  global: {
    total: number;
    covered: number;
    percentage: number;
  };
  files: {
    [filename: string]: {
      statements: {
        total: number;
        covered: number;
        percentage: number;
      };
      branches: {
        total: number;
        covered: number;
        percentage: number;
      };
      functions: {
        total: number;
        covered: number;
        percentage: number;
      };
      lines: {
        total: number;
        covered: number;
        percentage: number;
      };
    };
  };
}
```

## 测试用例设计

### 后端单元测试
```typescript
// API路由测试
describe('Account API', () => {
  describe('POST /api/accounts', () => {
    it('should create a new account', async () => {
      const accountData = {
        name: 'Test Account',
        description: 'Test Description',
        platform: 'wechat' as const,
      };
      
      const response = await request(app)
        .post('/api/accounts')
        .send(accountData)
        .expect(201);
      
      expect(response.body.success).toBe(true);
      expect(response.body.data.name).toBe(accountData.name);
      expect(response.body.data.id).toBeDefined();
    });
    
    it('should validate required fields', async () => {
      const response = await request(app)
        .post('/api/accounts')
        .send({ name: '' })
        .expect(400);
      
      expect(response.body.success).toBe(false);
      expect(response.body.errors).toContain('name is required');
    });
  });
});

// 服务层测试
describe('AccountService', () => {
  let accountService: AccountService;
  let mockAccountRepository: jest.Mocked<AccountRepository>;
  
  beforeEach(() => {
    mockAccountRepository = {
      create: jest.fn(),
      findById: jest.fn(),
      findAll: jest.fn(),
      update: jest.fn(),
      delete: jest.fn(),
    };
    accountService = new AccountService(mockAccountRepository);
  });
  
  describe('createAccount', () => {
    it('should create account with valid data', async () => {
      const accountData = {
        name: 'Test Account',
        description: 'Test Description',
        platform: 'wechat' as const,
      };
      
      mockAccountRepository.create.mockResolvedValue({
        id: '1',
        ...accountData,
        status: 'active',
        createdAt: new Date(),
        updatedAt: new Date(),
        contentCount: 0,
      });
      
      const result = await accountService.createAccount(accountData);
      
      expect(result).toMatchObject({
        name: accountData.name,
        description: accountData.description,
        platform: accountData.platform,
        status: 'active',
      });
      expect(mockAccountRepository.create).toHaveBeenCalledWith(accountData);
    });
  });
});
```

### 前端单元测试
```typescript
// 组件测试
describe('AccountList', () => {
  const mockAccounts = [
    {
      id: '1',
      name: 'Account 1',
      description: 'Description 1',
      platform: 'wechat' as const,
      status: 'active' as const,
      contentCount: 5,
      createdAt: new Date(),
      updatedAt: new Date(),
    },
    {
      id: '2',
      name: 'Account 2',
      description: 'Description 2',
      platform: 'wechat' as const,
      status: 'inactive' as const,
      contentCount: 0,
      createdAt: new Date(),
      updatedAt: new Date(),
    },
  ];

  it('should render accounts correctly', () => {
    render(
      <AccountList
        accounts={mockAccounts}
        onAccountSelect={jest.fn()}
        onAccountEdit={jest.fn()}
        onAccountDelete={jest.fn()}
      />
    );

    expect(screen.getByText('Account 1')).toBeInTheDocument();
    expect(screen.getByText('Account 2')).toBeInTheDocument();
    expect(screen.getByText('5')).toBeInTheDocument();
    expect(screen.getByText('0')).toBeInTheDocument();
  });

  it('should call onAccountSelect when account is clicked', () => {
    const mockOnSelect = jest.fn();
    render(
      <AccountList
        accounts={mockAccounts}
        onAccountSelect={mockOnSelect}
        onAccountEdit={jest.fn()}
        onAccountDelete={jest.fn()}
      />
    );

    fireEvent.click(screen.getByText('Account 1'));
    expect(mockOnSelect).toHaveBeenCalledWith(mockAccounts[0]);
  });
});

// 状态管理测试
describe('AccountStore', () => {
  let accountStore: AccountStore;
  
  beforeEach(() => {
    accountStore = new AccountStore();
  });
  
  describe('setAccounts', () => {
    it('should set accounts in store', () => {
      const accounts = [
        { id: '1', name: 'Account 1', description: 'Description 1', platform: 'wechat' as const, status: 'active' as const, contentCount: 0, createdAt: new Date(), updatedAt: new Date() },
      ];
      
      accountStore.setAccounts(accounts);
      
      expect(accountStore.accounts).toEqual(accounts);
    });
  });
  
  describe('addAccount', () => {
    it('should add account to store', () => {
      const account = { id: '1', name: 'Account 1', description: 'Description 1', platform: 'wechat' as const, status: 'active' as const, contentCount: 0, createdAt: new Date(), updatedAt: new Date() };
      
      accountStore.addAccount(account);
      
      expect(accountStore.accounts).toContain(account);
    });
  });
});
```

### 集成测试
```typescript
// API集成测试
describe('Account API Integration', () => {
  let app: Express;
  let database: Database;
  
  beforeAll(async () => {
    database = new Database(':memory:');
    await database.initialize();
    app = createApp(database);
  });
  
  afterAll(async () => {
    await database.close();
  });
  
  describe('Account CRUD Operations', () => {
    it('should create, read, update, and delete account', async () => {
      // Create
      const createResponse = await request(app)
        .post('/api/accounts')
        .send({
          name: 'Integration Test Account',
          description: 'Test Description',
          platform: 'wechat',
        })
        .expect(201);
      
      const accountId = createResponse.body.data.id;
      
      // Read
      const getResponse = await request(app)
        .get(`/api/accounts/${accountId}`)
        .expect(200);
      
      expect(getResponse.body.data.name).toBe('Integration Test Account');
      
      // Update
      const updateResponse = await request(app)
        .put(`/api/accounts/${accountId}`)
        .send({
          name: 'Updated Account Name',
        })
        .expect(200);
      
      expect(updateResponse.body.data.name).toBe('Updated Account Name');
      
      // Delete
      await request(app)
        .delete(`/api/accounts/${accountId}`)
        .expect(204);
      
      // Verify deletion
      await request(app)
        .get(`/api/accounts/${accountId}`)
        .expect(404);
    });
  });
});

// 工作流集成测试
describe('Content Generation Workflow', () => {
  let app: Express;
  let database: Database;
  let mockAIService: jest.Mocked<AIService>;
  
  beforeAll(async () => {
    database = new Database(':memory:');
    await database.initialize();
    
    mockAIService = {
      generateText: jest.fn(),
      generateTopics: jest.fn(),
      optimizeContent: jest.fn(),
      chat: jest.fn(),
    };
    
    app = createApp(database, mockAIService);
  });
  
  afterAll(async () => {
    await database.close();
  });
  
  it('should complete content generation workflow', async () => {
    // Setup mock responses
    mockAIService.generateTopics.mockResolvedValue({
      topics: [
        { id: '1', title: 'Topic 1', description: 'Description 1', score: 0.8, keywords: ['keyword1'] },
      ],
    });
    
    mockAIService.generateText.mockResolvedValue({
      content: 'Generated content',
      usage: { promptTokens: 100, completionTokens: 200, totalTokens: 300 },
    });
    
    // Create account
    const accountResponse = await request(app)
      .post('/api/accounts')
      .send({
        name: 'Test Account',
        description: 'Test Description',
        platform: 'wechat',
      })
      .expect(201);
    
    const accountId = accountResponse.body.data.id;
    
    // Create material
    const materialResponse = await request(app)
      .post('/api/materials')
      .send({
        title: 'Test Material',
        content: 'Test material content',
        type: 'text',
        accountId,
      })
      .expect(201);
    
    const materialId = materialResponse.body.data.id;
    
    // Generate topics
    const topicsResponse = await request(app)
      .post('/api/topics/generate')
      .send({
        materialId,
        count: 1,
      })
      .expect(200);
    
    const topicId = topicsResponse.body.data.topics[0].id;
    
    // Generate content
    const contentResponse = await request(app)
      .post('/api/content/generate')
      .send({
        topicId,
        accountId,
      })
      .expect(200);
    
    expect(contentResponse.body.data.content).toBe('Generated content');
  });
});
```

## 测试配置文件

### Jest配置
```javascript
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/src', '<rootDir>/tests'],
  testMatch: [
    '**/__tests__/**/*.ts',
    '**/?(*.)+(spec|test).ts',
  ],
  transform: {
    '^.+\\.ts$': 'ts-jest',
  },
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts',
    '!src/**/__tests__/**',
    '!src/**/index.ts',
  ],
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html'],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
  setupFilesAfterEnv: ['<rootDir>/tests/setup.ts'],
  testTimeout: 30000,
  verbose: true,
};
```

### 测试数据工厂
```typescript
// tests/factories.ts
export class AccountFactory {
  static build(overrides: Partial<Account> = {}): Account {
    return {
      id: faker.string.uuid(),
      name: faker.company.name(),
      description: faker.lorem.sentence(),
      platform: 'wechat',
      status: 'active',
      contentCount: faker.number.int({ min: 0, max: 100 }),
      createdAt: faker.date.past(),
      updatedAt: faker.date.recent(),
      ...overrides,
    };
  }
  
  static async create(overrides: Partial<Account> = {}): Promise<Account> {
    const account = this.build(overrides);
    return await AccountRepository.create(account);
  }
}

export class MaterialFactory {
  static build(overrides: Partial<Material> = {}): Material {
    return {
      id: faker.string.uuid(),
      title: faker.lorem.sentence(),
      content: faker.lorem.paragraphs(3),
      tags: [faker.lorem.word(), faker.lorem.word()],
      type: 'text',
      accountId: faker.string.uuid(),
      createdAt: faker.date.past(),
      ...overrides,
    };
  }
}
```

## 风险评估

### 技术风险
- **测试覆盖不足**: 关键功能测试缺失
- **测试维护成本**: 测试代码维护困难
- **测试执行时间**: 测试运行时间过长
- **测试数据管理**: 测试数据不一致

### 缓解措施
- 建立测试覆盖率监控和告警
- 使用测试数据工厂和Mock工具
- 实现测试并行执行和缓存
- 建立统一的测试数据管理策略

## 预估工作量
- **测试框架搭建**: 8小时
- **后端单元测试**: 20小时
- **前端单元测试**: 16小时
- **集成测试**: 24小时
- **测试覆盖率提升**: 12小时
- **CI/CD集成**: 8小时
- **文档编写**: 8小时
- **总计**: 96小时

## 相关资源
- [Jest文档](https://jestjs.io/)
- [React Testing Library](https://testing-library.com/)
- [Supertest](https://github.com/visionmedia/supertest)
- [测试覆盖率工具](https://istanbul.js.org/)

## 备注
- 定期审查和更新测试用例
- 实现测试自动化和监控
- 建立测试最佳实践规范
- 考虑性能测试和安全测试