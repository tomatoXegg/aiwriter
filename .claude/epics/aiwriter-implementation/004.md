---
name: "004-数据库设计和初始化"
description: "设计数据库表结构，创建数据模型，实现数据库初始化和迁移"
status: "completed"
priority: "high"
assigned_to: ""
labels: ["database", "design", "setup"]
type: "task"
epic: "aiwriter-implementation"
story_points: 8
created: "2025-09-04T01:26:29Z"
updated: "2025-09-04T11:00:00Z"
due_date: ""
blocked_by: ["001-项目初始化和环境搭建", "003-后端服务架构设置"]
blocking: []
---

# 任务：数据库设计和初始化

## 任务描述

基于aiwriter项目的业务需求，设计完整的数据库表结构，创建数据模型，实现数据库初始化、迁移和数据管理功能。

## 任务目标

- [ ] 设计数据库表结构和关系
- [ ] 创建SQLite数据库和表
- [ ] 实现数据模型和类型定义
- [ ] 创建数据库迁移脚本
- [ ] 实现数据初始化和种子数据
- [ ] 配置数据库工具函数

## 详细步骤

### 1. 数据库设计
- [ ] 分析业务需求，设计核心实体：
  - 账号（Account）
  - 素材（Material）
  - 选题（Topic）
  - 内容（Content）
  - 审查（Review）
  - 配置（Configuration）
- [ ] 设计表关系和约束
- [ ] 创建数据库ER图
- [ ] 设计索引和优化策略

### 2. 表结构设计
- [ ] 创建账号表（accounts）：
  ```sql
  CREATE TABLE accounts (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    platform TEXT DEFAULT 'wechat',
    status TEXT DEFAULT 'active',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    content_count INTEGER DEFAULT 0
  );
  ```

- [ ] 创建素材表（materials）：
  ```sql
  CREATE TABLE materials (
    id TEXT PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    tags TEXT, -- JSON格式存储
    type TEXT DEFAULT 'text',
    file_path TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    account_id TEXT,
    FOREIGN KEY (account_id) REFERENCES accounts(id)
  );
  ```

- [ ] 创建选题表（topics）：
  ```sql
  CREATE TABLE topics (
    id TEXT PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    material_id TEXT,
    prompt TEXT,
    status TEXT DEFAULT 'pending',
    score REAL DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (material_id) REFERENCES materials(id)
  );
  ```

- [ ] 创建内容表（contents）：
  ```sql
  CREATE TABLE contents (
    id TEXT PRIMARY KEY,
    title TEXT NOT NULL,
    body TEXT NOT NULL,
    topic_id TEXT,
    account_id TEXT,
    status TEXT DEFAULT 'draft',
    prompt TEXT,
    word_count INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (topic_id) REFERENCES topics(id),
    FOREIGN KEY (account_id) REFERENCES accounts(id)
  );
  ```

- [ ] 创建审查表（reviews）：
  ```sql
  CREATE TABLE reviews (
    id TEXT PRIMARY KEY,
    content_id TEXT,
    quality_score REAL DEFAULT 0,
    originality_score REAL DEFAULT 0,
    suggestions TEXT, -- JSON格式存储
    status TEXT DEFAULT 'pending',
    reviewed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (content_id) REFERENCES contents(id)
  );
  ```

- [ ] 创建配置表（configurations）：
  ```sql
  CREATE TABLE configurations (
    id TEXT PRIMARY KEY,
    key TEXT UNIQUE NOT NULL,
    value TEXT,
    type TEXT DEFAULT 'string',
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );
  ```

### 3. 数据模型创建
- [ ] 创建TypeScript类型定义：
  - `src/database/models/types.ts`
  - `src/database/models/Account.ts`
  - `src/database/models/Material.ts`
  - `src/database/models/Topic.ts`
  - `src/database/models/Content.ts`
  - `src/database/models/Review.ts`
  - `src/database/models/Configuration.ts`

- [ ] 实现数据模型类：
  - 基础模型类（BaseModel）
  - 具体模型类继承
  - 模型验证方法
  - 模型转换方法

### 4. 数据库初始化
- [ ] 创建数据库初始化脚本：
  - `src/database/init.ts`
  - `src/database/schema.sql`
  - `src/database/seed.sql`

- [ ] 实现数据库连接管理：
  - 连接池配置
  - 连接状态检查
  - 自动重连机制

- [ ] 创建数据库工具函数：
  - `src/database/utils.ts`
  - 数据库查询辅助函数
  - 事务处理函数
  - 错误处理函数

### 5. 数据迁移系统
- [ ] 创建迁移系统：
  - `src/database/migrations/`
  - 迁移版本管理
  - 迁移执行脚本

- [ ] 实现迁移功能：
  - 创建迁移（create）
  - 运行迁移（up）
  - 回滚迁移（down）
  - 迁移状态检查

### 6. 种子数据
- [ ] 创建种子数据脚本：
  - `src/database/seeds/`
  - 基础配置数据
  - 示例账号数据
  - 测试素材数据

- [ ] 实现种子数据管理：
  - 种子数据生成
  - 种子数据导入
  - 种子数据清理

## 验收标准

### 功能性验收
- [ ] 所有表结构创建成功
- [ ] 数据库连接正常
- [ ] 数据模型可以正常使用
- [ ] 迁移系统可以正常执行
- [ ] 种子数据可以正常导入

### 技术性验收
- [ ] 数据库设计符合第三范式
- [ ] 外键约束正确设置
- [ ] 索引设计合理
- [ ] 数据类型选择恰当
- [ ] 性能测试通过

### 数据完整性验收
- [ ] 数据约束有效
- [ ] 关系完整性保证
- [ ] 数据一致性检查通过
- [ ] 备份恢复机制正常

## 技术要求

### 数据库技术栈
- **数据库**: SQLite 3+
- **驱动**: sqlite3
- **迁移**: 自定义迁移系统
- **ORM**: 原生SQL（轻量级）

### 数据库设计原则
- **规范化**: 符合第三范式
- **性能**: 合理的索引设计
- **扩展**: 预留扩展字段
- **维护**: 清晰的命名规范

### 安全要求
- 输入数据验证
- SQL注入防护
- 数据加密存储
- 访问权限控制

## 风险评估

### 技术风险
- **数据一致性问题**: 实现事务和约束
- **性能问题**: 优化查询和索引
- **数据丢失风险**: 实现备份机制
- **迁移失败**: 设计回滚机制

### 缓解措施
- 使用数据库事务
- 实施性能监控
- 建立数据备份策略
- 完善迁移测试

## 预估工作量
- **数据库设计**: 4小时
- **表结构实现**: 2小时
- **数据模型**: 2小时
- **初始化脚本**: 1小时
- **迁移系统**: 2小时
- **种子数据**: 1小时
- **测试**: 2小时
- **总计**: 14小时

## 相关资源
- [SQLite官方文档](https://www.sqlite.org/)
- [数据库设计最佳实践](https://www.sqlshack.com/)
- [SQLite3 Node.js文档](https://www.npmjs.com/package/sqlite3)

## 备注
- 确保数据库设计支持业务扩展
- 为后续的数据分析预留字段
- 考虑数据库版本升级策略
- 设计清晰的数据库文档