---
name: "014-内容生成API开发"
description: "开发内容生成的后端API接口，包括AI内容生成、内容管理和风格控制功能"
status: "completed"
priority: "high"
assigned_to: ""
labels: ["backend", "api", "content-generation", "ai-integration"]
type: "task"
epic: "aiwriter-implementation"
story_points: 20
created: "2025-09-04T01:26:29Z"
updated: "2025-09-04T12:00:00Z"
due_date: ""
blocked_by: []
blocking: []
---

# 任务：内容生成API开发

## 任务描述

开发内容生成的后端API接口，集成Google Gemini AI服务实现智能内容生成、内容管理、风格控制和批量生成功能，为用户提供高质量的内容创作服务。

## 任务目标

- [ ] 创建内容管理相关的数据模型
- [ ] 实现AI内容生成功能
- [ ] 开发内容管理API接口
- [ ] 实现风格和长度控制
- [ ] 开发批量内容生成功能
- [ ] 添加内容版本管理和历史记录

## 详细步骤

### 1. 数据模型设计
- [ ] 定义Content数据模型接口
- [ ] 创建数据库表结构（contents表）
- [ ] 设计内容版本表结构
- [ ] 创建生成任务表结构

### 2. AI内容生成功能
- [ ] 实现基于选题的内容生成：POST /api/content/generate
- [ ] 实现自定义Prompt内容生成：POST /api/content/generate/custom
- [ ] 开发内容风格控制：POST /api/content/generate/styled
- [ ] 实现内容长度控制功能

### 3. 内容管理功能
- [ ] 实现内容列表查询：GET /api/content
- [ ] 实现内容详情查询：GET /api/content/:id
- [ ] 实现内容更新和编辑：PUT /api/content/:id
- [ ] 实现内容删除功能：DELETE /api/content/:id

### 4. 批量生成功能
- [ ] 实现批量内容生成：POST /api/content/generate/batch
- [ ] 实现批量任务管理：GET /api/content/batch/:id
- [ ] 实现批量结果查询：GET /api/content/batch/:id/results
- [ ] 实现批量操作状态跟踪

### 5. 内容版本管理
- [ ] 实现内容版本创建：POST /api/content/:id/versions
- [ ] 实现版本列表查询：GET /api/content/:id/versions
- [ ] 实现版本回滚功能：POST /api/content/:id/versions/:versionId/rollback
- [ ] 实现版本比较功能：GET /api/content/:id/versions/compare

### 6. 内容优化和格式化
- [ ] 实现内容格式化：POST /api/content/:id/format
- [ ] 实现内容优化建议：POST /api/content/:id/optimize
- [ ] 实现内容摘要生成：POST /api/content/:id/summary
- [ ] 实现内容标签提取：POST /api/content/:id/tags

## 验收标准

### 功能性验收
- [ ] AI内容生成功能正常工作
- [ ] 内容管理CRUD操作完整
- [ ] 风格和长度控制有效
- [ ] 批量生成功能稳定
- [ ] 版本管理功能完善

### 技术性验收
- [ ] AI服务调用稳定可靠
- [ ] 内容生成响应时间 < 60秒
- [ ] 数据存储和查询性能良好
- [ ] 批量任务处理稳定
- [ ] 版本管理数据一致性

### 业务验收
- [ ] 生成内容质量达到可接受水平
- [ ] 支持多种内容风格和长度
- [ ] 批量生成效率高
- [ ] 版本管理功能实用

## 技术要求

### 后端技术栈
- **框架**: Express 4+
- **语言**: TypeScript 4.8+
- **数据库**: SQLite 3+
- **AI服务**: Google Gemini API
- **任务队列**: Bull或自定义队列

### API设计规范
- **RESTful**: 遵循REST API设计原则
- **异步处理**: 支持长时间运行的生成任务
- **分页**: 支持分页和限制
- **状态管理**: 实现任务状态跟踪
- **缓存**: 实现生成结果缓存

### 数据模型
```typescript
interface Content {
  id: string;
  title: string;
  body: string;
  topicId: string;
  accountId: string;
  status: 'draft' | 'generating' | 'generated' | 'reviewed' | 'published';
  prompt: string;
  style?: {
    tone: 'formal' | 'casual' | 'professional' | 'creative';
    length: 'short' | 'medium' | 'long';
    format: 'article' | 'blog' | 'report' | 'story';
  };
  metadata: {
    wordCount: number;
    readTime: number;
    language: string;
    tags: string[];
    category: string;
  };
  createdAt: Date;
  updatedAt: Date;
  publishedAt?: Date;
}

interface ContentVersion {
  id: string;
  contentId: string;
  version: number;
  title: string;
  body: string;
  changeLog: string;
  createdAt: Date;
  createdBy: string;
}

interface ContentGeneration {
  id: string;
  topicId: string;
  prompt: string;
  style?: Content['style'];
  status: 'pending' | 'processing' | 'completed' | 'failed';
  result?: Content;
  error?: string;
  progress: number;
  estimatedTime: number;
  createdAt: Date;
  completedAt?: Date;
}

interface BatchGeneration {
  id: string;
  name: string;
  topics: string[];
  prompt: string;
  style?: Content['style'];
  status: 'pending' | 'processing' | 'completed' | 'failed';
  results: ContentGeneration[];
  createdAt: Date;
  completedAt?: Date;
}
```

## API接口设计

### 生成内容
```typescript
POST /api/content/generate
Request: {
  topicId: string;
  prompt?: string;
  style?: {
    tone: 'formal' | 'casual' | 'professional' | 'creative';
    length: 'short' | 'medium' | 'long';
    format: 'article' | 'blog' | 'report' | 'story';
  };
}
Response: {
  success: boolean;
  data: {
    generationId: string;
    status: 'pending' | 'processing';
    estimatedTime: number;
  };
  message: string;
}
```

### 获取生成结果
```typescript
GET /api/content/generations/:id
Response: {
  success: boolean;
  data: {
    id: string;
    status: 'pending' | 'processing' | 'completed' | 'failed';
    result?: Content;
    error?: string;
    progress: number;
    createdAt: Date;
    completedAt?: Date;
  };
  message: string;
}
```

### 内容列表查询
```typescript
GET /api/content?page=1&limit=10&status=generated&accountId=id&topicId=id
Response: {
  success: boolean;
  data: {
    contents: Content[];
    total: number;
    page: number;
    limit: number;
    filters: {
      status?: string;
      accountId?: string;
      topicId?: string;
    };
  };
  message: string;
}
```

### 批量生成内容
```typescript
POST /api/content/generate/batch
Request: {
  name: string;
  topicIds: string[];
  prompt?: string;
  style?: Content['style'];
}
Response: {
  success: boolean;
  data: {
    batchId: string;
    status: 'pending';
    estimatedTime: number;
    taskCount: number;
  };
  message: string;
}
```

### 内容版本管理
```typescript
POST /api/content/:id/versions
Request: {
  title: string;
  body: string;
  changeLog: string;
}
Response: {
  success: boolean;
  data: {
    version: ContentVersion;
    currentVersion: number;
  };
  message: string;
}
```

### 内容优化建议
```typescript
POST /api/content/:id/optimize
Response: {
  success: boolean;
  data: {
    contentId: string;
    suggestions: {
      readability: {
        score: number;
        issues: string[];
        improvements: string[];
      };
      grammar: {
        score: number;
        issues: string[];
        corrections: string[];
      };
      style: {
        score: number;
        suggestions: string[];
      };
      structure: {
        score: number;
        recommendations: string[];
      };
    };
  };
  message: string;
}
```

## 风险评估

### 技术风险
- **AI服务依赖**: Google Gemini API的可用性和限制
- **响应时间**: 内容生成可能需要较长时间
- **数据一致性**: 批量操作的数据一致性
- **存储成本**: 大量内容数据的存储成本

### 缓解措施
- 实现API调用重试和降级策略
- 使用异步任务队列处理长时间操作
- 实现事务管理和数据校验
- 实现数据压缩和清理机制

## 预估工作量
- **需求分析和设计**: 5小时
- **数据模型开发**: 6小时
- **AI服务集成**: 10小时
- **API接口开发**: 15小时
- **测试和调试**: 12小时
- **文档编写**: 5小时
- **总计**: 53小时

## 相关资源
- [Google Gemini API文档](https://ai.google.dev/)
- [Express异步处理](https://expressjs.com/)
- [Bull任务队列](https://github.com/OptimalBits/bull)
- [SQLite事务管理](https://www.sqlite.org/lang_transaction.html)

## 备注
- 考虑添加内容质量评分功能
- 实现内容自动保存功能
- 添加内容协作功能
- 考虑支持多种输出格式（Markdown、HTML等）